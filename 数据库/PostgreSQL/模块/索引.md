# B+树索引

来源：[PostgreSQL BTree(B-Link-Tree变种) 索引基本实现原理 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/639226810)

B树和相关变种是专门用于构建内存索引查找存储于磁盘的数据，B树本质就是存储kv对的自平衡多叉树，具有以下性质(假设度为2)：

1. 每一条从root 根节点 到 leaf 叶子 节点的路径高度都是完全相同的。
2. root 节点要么是叶子节点（只有一个节点的情况），要么拥有两个子节点
3. 除了root 根节点之外的节点至少包含 t - 1 个key 或者 upper ( m /2 ) - 1个key
4. 除了 root 节点 以及 leaf 节点之外的内部节点 至少包含 t 个子节点，最多包含2*t个子节点，或者说 内部节点的子节点个数等于其当前包含的 key 个数 + 1
5. 每一个节点内部最多存储 2t - 1 个key
6. 节点内部的key 是升序排列
7. 大多数kv对都在叶子节点，也允许内部节点保存kv对，叶子节点有n个key，就有n+1个指针

度越大，树就越宽，索引深度就越浅

degree t = 2 的 BTree 形态如下：

![img](https://pic2.zhimg.com/80/v2-6d96bedc46a1794b2aa48ff4b71bd7d5_720w.webp)

基于B树延展出了B+树，它具有减少IO和便于顺序遍历访问的场景两大好处

比如 一个 BTree 的 t = 512，也就是一个节点内部最多存储 1023个key，这样的三层B+Tree 能够保存 10亿个key，如果只有root节点被存储到内存，查找一个key的数据也只需要两次随机IO 加载到key所在的叶子节点的pages，并在内存中二分查找即可；当然实际 root 节点 以及 第一层的key肯定都能被存储到内存中，这样的查询效率会更高。

一个degree 为2 的B+Tree的形态如下：

![img](https://pic4.zhimg.com/80/v2-8f5a4344be24518c7aae3821c5fa7f4b_720w.webp)

B-linked-Tree在B+Tree的基础上解决了并发访问性能的问题，具体的，B-Link-Tree 在B+Tree的基础上又增加了两个性质：

1. 为每一个内部节点 新增了一个指向兄弟节点的右向指针。
2. 为每一个内部节点引入一个额外的key (high-key)，它是当前节点以及所有子节点中最大的key。

B-Link-Tree 的形态如下：

![img](https://pic3.zhimg.com/80/v2-6bbb0288559fc6e8189c9c0c79b3318a_720w.webp)

**插入操作**

对于要插入的key，首先会二分找到叶子节点插入，然后判断是否分裂，如果要分裂则选择中间key进行level up(自身有可能留也有可能不留)放入到父节点，再进行同样的判断，在此过程中同步更新key number和high-key等中间量

- max childens = 4
- internal节点 min childens = 2
- max keys = 2*t - 1 = 3
- min keys = t-1 = 1

**PostgreSQL BTree结构**

在PG中，如果查询不走索引，就需要将整个表文件按照磁盘上的顺序载入缓存中，然后一个个page的扫描得到结果

在PG中整个 BTree 作为 Index ，其基本的形态如下：

![img](https://pic1.zhimg.com/80/v2-8ed152d106ea195db87fae78962c6334_720w.webp)

- PG 中的 BTree 是一个略有变动的 B-Link-Tree，即内部节点增加了左向指针。
- 基本的BTree 索引持久化形态是和 Heap 表基本一样（除了唯一的Meta page），每一个节点保存到一个page，节点内的key 已经 子节点保存的value都会作为index tuple 保存到该 page中。
- Meta page 用来保存当前BTree 的元数据，也是索引page的第0页
- Inner Node(page) 内部节点，其index-tuple 中 仅保存key 以及指向子节点的指针
- Leaf Node(page) 叶子节点，是BTree 索引的最底层，其内部的 index-tuple 保存的是key 以及 指向 数据tuple的 tid。通过 tid 能够访问这个key 对应的实际数据。
- 每一个节点所在的page 内部最后有一部分 Special space空间，保存了当前节点或者说 index-page 的元数据，其是通过 `BTPageOpaqueData`表示。主要保存这个 page 左右方向指针、page所在 BTree 层级、以及当前页面的状态（叶子节点/内部节点/根节点/删除页面......）

PG中分裂的条件不是依据 每一个节点内部 key的个数，而是节点所在page的大小，比如page 没有插入下一个tuple 的空间了，则才会触发分裂。

索引的key：在PostgreSQL中，B树索引的键（key）是一个包含一个或多个列值的数据结构。如果列值相同，B树索引将使用附加的排序规则来处理它们，例如使用TID确保键值唯一

# 哈希索引





# GIN索引





# BRIN索引



