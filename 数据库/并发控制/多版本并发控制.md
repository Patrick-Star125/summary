MULTI-VERSION CONCURRENCY CONTROL即多版本并发控制，指将数据库的更改当作一个版本，通过时间戳管理版本的并发控制手段，一般MVCC结合2PL、T/O、OCC来一起提供并发控制方案。

## MVCC概述

多版本并发控制（MVCC）是一个比并发控制协议更大的概念。它涉及数据库管理系统设计和实现的各个方面。MVCC是数据库管理系统中使用最广泛的方案。在过去10年中，几乎每一个新的DBMS都使用了它。甚至一些不支持多语句事务的系统（例如NoSQL）也支持它。

通过MVCC，DBMS在数据库中维护单个逻辑对象的多个物理版本。**当事务写入对象时，DBMS会创建该对象的新版本。当事务读取对象时，它会读取事务启动时存在的最新版本。**

> 此处版本不能简单理解成数据的一个备份，后面会讲到为什么

MVCC的基本概念/优点是，写事务不会阻塞写事务，读事务也不会阻塞读事务。这意味着一个事务可以修改对象的同时其他事务可以读取旧版本。

使用MVCC的一个优点是，只读事务可以读取数据库的一致快照，而无需使用任何类型的锁。此外，多版本DBMS可以轻松支持时间旅行查询，这是基于数据库在其他某个时间点的状态的查询（例如，像3小时前那样对数据库执行查询）

在MVCC中，有以下四个设计要点：

* 并发控制方法
* 版本存储
* 垃圾回收
* 索引管理

其中并发控制方法指代之间讲过的方法包括2PL、T/O、OCC。

## 版本存储

DBMS使用元组的指针字段为每个逻辑元组创建一个版本链，它本质上是一个按时间戳排序的版本链表。这允许DBMS查找特定事务在运行时可见的版本。索引总是指向链的“头”，链表头代表最新或最旧的版本。当需要读写版本时，专有线程遍历链，直到找到正确的版本。不同的存储方案决定了每个版本的存储位置/内容。

**方案一：Append-Only**

逻辑元组的所有物理版本都存储在相同的表空间中。版本在表中混合在一起，每次更新只是将元组的新版本附加到表中，并更新版本链。链可以被排序为从最旧到最新（Old to New），这需要在查找时进行链遍历，或者从最新到最旧（New to Old），这需要为每个新版本更新索引指针。

![](http://pic.netpunk.space/images/2022/07/02/20220702193021.png)

**方案二：Time-Travel Storage**

DBMS维护一个称为时间旅行表的**单独表**，该表存储元组的旧版本。每次更新时，DBMS都会将元组的旧版本复制到时间旅行表中，并用新数据覆盖主表中的元组。主表中的元组指针指向时间旅行表中的过去版本。

![](http://pic.netpunk.space/images/2022/07/02/20220702193242.png)

**方案三：Delta Storage**

与时间旅行存储类似，DBMS不是存储整个过去的元组，而是只存储增量，或元组之间的变化，即所谓的增量存储段。然后，事务可以通过迭代Delta来重新创建旧版本。这导致写入速度比时间旅行存储快，且更节省存储空间，但读取速度较慢。

![](http://pic.netpunk.space/images/2022/07/02/20220702193406.png)

## 垃圾回收

DBMS需要随着时间的推移从数据库中删除可回收的物理版本。如果没有活动事务可以“看到”该版本，或者该版本是由中止的事务创建的，则该版本是可重新申请的



## 索引管理

























