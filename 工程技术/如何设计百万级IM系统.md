原文：[从0到1再到N，探索亿级流量的IM架构演绎 - 飞书云文档 (feishu.cn)](https://nxwz51a5wp.feishu.cn/docs/doccnTYWSZg4v9bYTQH8hXkGJPc)

# 功能和约束

~~~
1. 添加好友
2. 聊天会话列表
3. 单聊  用户A给用户B发消息
4. 群聊 多个用户在一个聊天室内聊天
5. 多设备登陆
6. 消息漫游
7. 消息已读，查看已读/未读列表
~~~

~~~
1. DAU 10亿 预估QPS和存储消耗
2. 可靠性要求5个9
3. 收发消息延迟在10ms以下
4. 消息时序一致性(发送与接收端的消息顺序一致，不重不漏)
5. 万人群聊
6. 可运维性
~~~

IM系统是IO密集型系统，系统瓶颈在频繁的网络调用上

可靠性：消息一旦显示发送成功就必定送达对端

一致性：

# 低延时

![image-20240308112710610](C:\Users\NetPunk\AppData\Roaming\Typora\typora-user-images\image-20240308112710610.png)

1. 一致性哈希
2. 长链接（点对点推、群聊拉）
3. 分离DB，尽量不走落盘
4. 合并DB查询/合并高并发消息
5. IPConfig分配IP，做服务发现
6. state服务分离可变业务，保持长链接服务无状态
7. 路由服务提供长链接-session_id映射（保存在KV），并用MQ削峰填谷
8. 本地LRU-memDB-DB分级存储
9. KV存储/图数据库/存储代理
10. 高并发服务降级
11. 定时任务算法改为（时间轮算法）-[时间轮在Kafka的实践](https://www.infoq.cn/article/erdajpj5epir65iczxzi)

# 一致性

1. 时序一致性要保证上下行消息不重复、不丢失、不乱序

2. 每个消息分配ID、id严格递增、重复消息过滤、消息超时重传

3. 双ID链+推拉结合

   ![image-20240309160302654](C:\Users\NetPunk\AppData\Roaming\Typora\typora-user-images\image-20240309160302654.png)
   
4. gossip算法是一种保证最终一致、完全分布式、容错性强、性能较差的一致性算法

# 可用性

1. 尽可能保持长链接在各种条件下稳定连接或者快速重连
2. 业务层心跳（自适应心跳包、小包）
3. 服务端延迟断开连接
4. 服务发现快速替换故障机器
5. 优化协议和连接（QUIC协议是基于UDP的可靠协议，支持0-RTT连接恢复、多路复用、加密传输）
6. 异地多活



# 运维

1. 云原生架构、指标观察平台（业务指标、系统指标、运行日志）
2. 长链接服务的热启动
3. 端到端全链路加密
4. 静态资源局部敏感哈希识别重复数据
5. 